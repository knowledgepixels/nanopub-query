<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainVerticle.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Nanopub Query</a> &gt; <a href="index.source.html" class="el_package">com.knowledgepixels.query</a> &gt; <span class="el_source">MainVerticle.java</span></div><h1>MainVerticle.java</h1><pre class="source lang-java linenums">package com.knowledgepixels.query;

import com.github.jsonldjava.shaded.com.google.common.base.Charsets;
import io.micrometer.prometheus.PrometheusMeterRegistry;
import io.vertx.core.AbstractVerticle;
import io.vertx.core.Future;
import io.vertx.core.MultiMap;
import io.vertx.core.Promise;
import io.vertx.core.http.*;
import io.vertx.ext.web.Router;
import io.vertx.ext.web.RoutingContext;
import io.vertx.ext.web.handler.CorsHandler;
import io.vertx.ext.web.handler.StaticHandler;
import io.vertx.ext.web.proxy.handler.ProxyHandler;
import io.vertx.httpproxy.*;
import io.vertx.micrometer.PrometheusScrapingHandler;
import io.vertx.micrometer.backends.BackendRegistries;
import org.apache.http.HttpStatus;
import org.eclipse.rdf4j.model.Value;
import org.eclipse.rdf4j.rio.RDFFormat;
import org.nanopub.MalformedNanopubException;
import org.nanopub.Nanopub;
import org.nanopub.NanopubImpl;

import java.io.InputStream;
import java.net.URLEncoder;
import java.util.*;
import java.util.Map.Entry;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

/**
 * Main verticle that coordinates the incoming HTTP requests.
 */
<span class="nc" id="L35">public class MainVerticle extends AbstractVerticle {</span>

<span class="nc" id="L37">    private boolean server1Started = false;</span>
<span class="nc" id="L38">    private boolean server2Started = false;</span>

<span class="nc" id="L40">    private static String css = null;</span>

    private boolean allServersStarted() {
<span class="nc bnc" id="L43" title="All 4 branches missed.">        return server1Started &amp;&amp; server2Started;</span>
    }

    /**
     * Start the main verticle.
     *
     * @param startPromise the promise to complete when the verticle is started
     * @throws Exception if an error occurs during startup
     */
    @Override
    public void start(Promise&lt;Void&gt; startPromise) throws Exception {
<span class="nc" id="L54">        HttpClient httpClient = vertx.createHttpClient(</span>
                new HttpClientOptions()
<span class="nc" id="L56">                        .setConnectTimeout(1000).setIdleTimeoutUnit(TimeUnit.SECONDS)</span>
<span class="nc" id="L57">                        .setIdleTimeout(60).setReadIdleTimeout(60).setWriteIdleTimeout(60),</span>
<span class="nc" id="L58">                new PoolOptions().setHttp1MaxSize(200).setHttp2MaxSize(200)</span>
        );

<span class="nc" id="L61">        HttpServer proxyServer = vertx.createHttpServer();</span>
<span class="nc" id="L62">        Router proxyRouter = Router.router(vertx);</span>
<span class="nc" id="L63">        proxyRouter.route().handler(CorsHandler.create().addRelativeOrigin(&quot;.*&quot;));</span>

        // Metrics
<span class="nc" id="L66">        final var metricsHttpServer = vertx.createHttpServer();</span>
<span class="nc" id="L67">        final var metricsRouter = Router.router(vertx);</span>
<span class="nc" id="L68">        metricsHttpServer.requestHandler(metricsRouter).listen(9394);</span>

<span class="nc" id="L70">        final var metricsRegistry = (PrometheusMeterRegistry) BackendRegistries.getDefaultNow();</span>
<span class="nc" id="L71">        final var collector = new MetricsCollector(metricsRegistry);</span>
<span class="nc" id="L72">        metricsRouter.route(&quot;/metrics&quot;).handler(PrometheusScrapingHandler.create(metricsRegistry));</span>
        // ----------
        // This part is only used if the redirection is not done through Nginx.
        // See nginx.conf and this bug report: https://github.com/eclipse-rdf4j/rdf4j/discussions/5120
<span class="nc" id="L76">        HttpProxy rdf4jProxy = HttpProxy.reverseProxy(httpClient);</span>
<span class="nc" id="L77">        String proxy = Utils.getEnvString(&quot;RDF4J_PROXY_HOST&quot;, &quot;rdf4j&quot;);</span>
<span class="nc" id="L78">        int proxyPort = Utils.getEnvInt(&quot;RDF4J_PROXY_PORT&quot;, 8080);</span>
<span class="nc" id="L79">        rdf4jProxy.origin(proxyPort, proxy);</span>

<span class="nc" id="L81">        rdf4jProxy.addInterceptor(new ProxyInterceptor() {</span>

            @Override
            public Future&lt;ProxyResponse&gt; handleProxyRequest(ProxyContext context) {
<span class="nc" id="L85">                ProxyRequest request = context.request();</span>
<span class="nc" id="L86">                request.setURI(request.getURI().replaceAll(&quot;/&quot;, &quot;_&quot;).replaceFirst(&quot;^_repo_&quot;, &quot;/rdf4j-server/repositories/&quot;));</span>
                // For later to try to get HTML tables out:
//				if (request.headers().get(&quot;Accept&quot;) == null) {
//					request.putHeader(&quot;Accept&quot;, &quot;text/html&quot;);
//				}
//				request.putHeader(&quot;Accept&quot;, &quot;application/json&quot;);
<span class="nc" id="L92">                return ProxyInterceptor.super.handleProxyRequest(context);</span>
            }

            @Override
            public Future&lt;Void&gt; handleProxyResponse(ProxyContext context) {
<span class="nc" id="L97">                ProxyResponse resp = context.response();</span>
<span class="nc" id="L98">                resp.putHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span>
<span class="nc" id="L99">                resp.putHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;POST, GET, OPTIONS&quot;);</span>
                // For later to try to get HTML tables out:
//				String acceptHeader = context.request().headers().get(&quot;Accept&quot;);
//				if (acceptHeader != null &amp;&amp; acceptHeader.contains(&quot;text/html&quot;)) {
//					resp.putHeader(&quot;Content-Type&quot;, &quot;text/html&quot;);
//					resp.setBody(Body.body(Buffer.buffer(&quot;&lt;html&gt;&lt;body&gt;&lt;strong&gt;test&lt;/strong&gt;&lt;/body&gt;&lt;/html&gt;&quot;)));
//				}
<span class="nc" id="L106">                return ProxyInterceptor.super.handleProxyResponse(context);</span>
            }

        });
        // ----------

<span class="nc" id="L112">        proxyRouter.route(HttpMethod.GET, &quot;/repo&quot;).handler(req -&gt; handleRedirect(req, &quot;/repo&quot;));</span>
<span class="nc" id="L113">        proxyRouter.route(HttpMethod.GET, &quot;/repo/*&quot;).handler(ProxyHandler.create(rdf4jProxy));</span>
<span class="nc" id="L114">        proxyRouter.route(HttpMethod.POST, &quot;/repo/*&quot;).handler(ProxyHandler.create(rdf4jProxy));</span>
<span class="nc" id="L115">        proxyRouter.route(HttpMethod.HEAD, &quot;/repo/*&quot;).handler(ProxyHandler.create(rdf4jProxy));</span>
<span class="nc" id="L116">        proxyRouter.route(HttpMethod.OPTIONS, &quot;/repo/*&quot;).handler(ProxyHandler.create(rdf4jProxy));</span>
<span class="nc" id="L117">        proxyRouter.route(HttpMethod.GET, &quot;/tools/*&quot;).handler(req -&gt; {</span>
<span class="nc" id="L118">            final String yasguiPattern = &quot;^/tools/([a-zA-Z0-9-_]+)(/([a-zA-Z0-9-_]+))?/yasgui\\.html$&quot;;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (req.normalizedPath().matches(yasguiPattern)) {</span>
<span class="nc" id="L120">                String repo = req.normalizedPath().replaceFirst(yasguiPattern, &quot;$1$2&quot;);</span>
<span class="nc" id="L121">                req.response()</span>
<span class="nc" id="L122">                        .putHeader(&quot;content-type&quot;, &quot;text/html&quot;)</span>
<span class="nc" id="L123">                        .end(&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>
                                + &quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot;
                                + &quot;&lt;head&gt;\n&quot;
                                + &quot;&lt;meta charset=\&quot;utf-8\&quot;&gt;\n&quot;
                                + &quot;&lt;meta http-equiv=\&quot;X-UA-Compatible\&quot; content=\&quot;IE=edge\&quot;&gt;\n&quot;
                                + &quot;&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1\&quot;&gt;\n&quot;
                                + &quot;&lt;title&gt;Nanopub Query SPARQL Editor for repository: &quot; + repo + &quot;&lt;/title&gt;\n&quot;
                                + &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/style.css\&quot;&gt;\n&quot;
                                + &quot;&lt;link href='https://cdn.jsdelivr.net/yasgui/2.6.1/yasgui.min.css' rel='stylesheet' type='text/css'/&gt;\n&quot;
                                + &quot;&lt;style&gt;.yasgui .endpointText {display:none !important;}&lt;/style&gt;\n&quot;
                                + &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;localStorage.clear();&lt;/script&gt;\n&quot;
                                + &quot;&lt;/head&gt;\n&quot;
                                + &quot;&lt;body&gt;\n&quot;
                                + &quot;&lt;h3&gt;Nanopub Query SPARQL Editor for repository: &quot; + repo + &quot;&lt;/h3&gt;\n&quot;
                                + &quot;&lt;div id='yasgui'&gt;&lt;/div&gt;\n&quot;
                                + &quot;&lt;script src='https://cdn.jsdelivr.net/yasgui/2.6.1/yasgui.min.js'&gt;&lt;/script&gt;\n&quot;
                                + &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;\n&quot;
                                + &quot;var yasgui = YASGUI(document.getElementById(\&quot;yasgui\&quot;), {\n&quot;
<span class="nc" id="L141">                                + &quot;  yasqe:{sparql:{endpoint:'/repo/&quot; + repo + &quot;'},value:'&quot; + Utils.defaultQuery.replaceAll(&quot;\n&quot;, &quot;\\\\n&quot;) + &quot;'}\n&quot;</span>
                                + &quot;});\n&quot;
                                + &quot;&lt;/script&gt;\n&quot;
                                + &quot;&lt;/body&gt;\n&quot;
                                + &quot;&lt;/html&gt;&quot;);
<span class="nc" id="L146">            } else {</span>
<span class="nc" id="L147">                req.response()</span>
<span class="nc" id="L148">                        .putHeader(&quot;content-type&quot;, &quot;text/plain&quot;)</span>
<span class="nc" id="L149">                        .setStatusCode(404)</span>
<span class="nc" id="L150">                        .end(&quot;not found&quot;);</span>
            }
<span class="nc" id="L152">        });</span>
<span class="nc" id="L153">        proxyRouter.route(HttpMethod.GET, &quot;/page&quot;).handler(req -&gt; handleRedirect(req, &quot;/page&quot;));</span>
<span class="nc" id="L154">        proxyRouter.route(HttpMethod.GET, &quot;/page/*&quot;).handler(req -&gt; {</span>
<span class="nc" id="L155">            final String pagePattern = &quot;^/page/([a-zA-Z0-9-_]+)(/([a-zA-Z0-9-_]+))?$&quot;;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (req.normalizedPath().matches(pagePattern)) {</span>
<span class="nc" id="L157">                String repo = req.normalizedPath().replaceFirst(pagePattern, &quot;$1$2&quot;);</span>
<span class="nc" id="L158">                req.response()</span>
<span class="nc" id="L159">                        .putHeader(&quot;content-type&quot;, &quot;text/html&quot;)</span>
<span class="nc" id="L160">                        .end(&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>
                                + &quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot;
                                + &quot;&lt;head&gt;\n&quot;
                                + &quot;&lt;meta charset=\&quot;utf-8\&quot;&gt;\n&quot;
                                + &quot;&lt;meta http-equiv=\&quot;X-UA-Compatible\&quot; content=\&quot;IE=edge\&quot;&gt;\n&quot;
                                + &quot;&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1\&quot;&gt;\n&quot;
                                + &quot;&lt;title&gt;Nanopub Query repo: &quot; + repo + &quot;&lt;/title&gt;\n&quot;
                                + &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/style.css\&quot;&gt;\n&quot;
                                + &quot;&lt;/head&gt;\n&quot;
                                + &quot;&lt;body&gt;\n&quot;
                                + &quot;&lt;h3&gt;Nanopub Query repo: &quot; + repo + &quot;&lt;/h3&gt;\n&quot;
                                + &quot;&lt;p&gt;Endpoint: &lt;a href=\&quot;/repo/&quot; + repo + &quot;\&quot;&gt;/repo/&quot; + repo + &quot;&lt;/a&gt;&lt;/p&gt;&quot;
                                + &quot;&lt;p&gt;YASGUI: &lt;a href=\&quot;/tools/&quot; + repo + &quot;/yasgui.html\&quot;&gt;/tools/&quot; + repo + &quot;/yasgui.hml&lt;/a&gt;&lt;/p&gt;&quot;
                                + &quot;&lt;/body&gt;\n&quot;
                                + &quot;&lt;/html&gt;&quot;);
<span class="nc" id="L175">            } else {</span>
<span class="nc" id="L176">                req.response()</span>
<span class="nc" id="L177">                        .putHeader(&quot;content-type&quot;, &quot;text/plain&quot;)</span>
<span class="nc" id="L178">                        .setStatusCode(404)</span>
<span class="nc" id="L179">                        .end(&quot;not found&quot;);</span>
            }
<span class="nc" id="L181">        });</span>
<span class="nc" id="L182">        proxyRouter.route(HttpMethod.GET, &quot;/&quot;).handler(req -&gt; {</span>
<span class="nc" id="L183">            String repos = &quot;&quot;;</span>
<span class="nc" id="L184">            List&lt;String&gt; repoList = new ArrayList&lt;&gt;(TripleStore.get().getRepositoryNames());</span>
<span class="nc" id="L185">            Collections.sort(repoList);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            for (String s : repoList) {</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">                if (s.startsWith(&quot;pubkey_&quot;) || s.startsWith(&quot;type_&quot;)) continue;</span>
<span class="nc" id="L188">                repos += &quot;&lt;li&gt;&lt;code&gt;&lt;a href=\&quot;/page/&quot; + s + &quot;\&quot;&gt;&quot; + s + &quot;&lt;/a&gt;&lt;/code&gt;&lt;/li&gt;&quot;;</span>
<span class="nc" id="L189">            }</span>
<span class="nc" id="L190">            String pinnedApisValue = Utils.getEnvString(&quot;NANOPUB_QUERY_PINNED_APIS&quot;, &quot;&quot;);</span>
<span class="nc" id="L191">            String[] pinnedApis = pinnedApisValue.split(&quot; &quot;);</span>
<span class="nc" id="L192">            String pinnedApiLinks = &quot;&quot;;</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (!pinnedApisValue.isEmpty()) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                for (String s : pinnedApis) {</span>
<span class="nc" id="L195">                    pinnedApiLinks = pinnedApiLinks + &quot;&lt;li&gt;&lt;a href=\&quot;openapi/?url=spec/&quot; + s + &quot;%3Fapi-version=latest\&quot;&gt;&quot; + s.replaceFirst(&quot;^.*/&quot;, &quot;&quot;) + &quot;&lt;/a&gt;&lt;/li&gt;&quot;;</span>
                }
<span class="nc" id="L197">                pinnedApiLinks = &quot;&lt;p&gt;Pinned APIs:&lt;/p&gt;\n&quot; +</span>
                        &quot;&lt;ul&gt;\n&quot; +
                        pinnedApiLinks +
                        &quot;&lt;/ul&gt;\n&quot;;
            }
<span class="nc" id="L202">            req.response()</span>
<span class="nc" id="L203">                    .putHeader(&quot;content-type&quot;, &quot;text/html&quot;)</span>
<span class="nc" id="L204">                    .end(&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>
                            + &quot;&lt;html lang='en'&gt;\n&quot;
                            + &quot;&lt;head&gt;\n&quot;
                            + &quot;&lt;title&gt;Nanopub Query&lt;/title&gt;\n&quot;
                            + &quot;&lt;meta charset='utf-8'&gt;\n&quot;
                            + &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/style.css\&quot;&gt;\n&quot;
                            + &quot;&lt;/head&gt;\n&quot;
                            + &quot;&lt;body&gt;\n&quot;
                            + &quot;&lt;h1&gt;Nanopub Query&lt;/h1&gt;&quot;
                            + &quot;&lt;p&gt;General repos:&lt;/p&gt;&quot;
                            + &quot;&lt;ul&gt;&quot; + repos + &quot;&lt;/ul&gt;&quot;
                            + &quot;&lt;p&gt;Specific repos:&lt;/p&gt;&quot;
                            + &quot;&lt;ul&gt;&quot;
                            + &quot;&lt;li&gt;&lt;a href=\&quot;/pubkeys\&quot;&gt;Pubkey Repos&lt;/a&gt;&lt;/li&gt;&quot;
                            + &quot;&lt;li&gt;&lt;a href=\&quot;/types\&quot;&gt;Type Repos&lt;/a&gt;&lt;/li&gt;&quot;
                            + &quot;&lt;/ul&gt;&quot;
                            + pinnedApiLinks
                            + &quot;&lt;/body&gt;\n&quot;
                            + &quot;&lt;/html&gt;&quot;);
<span class="nc" id="L223">        });</span>
<span class="nc" id="L224">        proxyRouter.route(HttpMethod.GET, &quot;/pubkeys&quot;).handler(req -&gt; {</span>
<span class="nc" id="L225">            String repos = &quot;&quot;;</span>
<span class="nc" id="L226">            List&lt;String&gt; repoList = new ArrayList&lt;&gt;(TripleStore.get().getRepositoryNames());</span>
<span class="nc" id="L227">            Collections.sort(repoList);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            for (String s : repoList) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (!s.startsWith(&quot;pubkey_&quot;)) continue;</span>
<span class="nc" id="L230">                String hash = s.replaceFirst(&quot;^([a-zA-Z0-9-]+)_([a-zA-Z0-9-_]+)$&quot;, &quot;$2&quot;);</span>
<span class="nc" id="L231">                Value hashObj = Utils.getObjectForHash(hash);</span>
                String label;
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (hashObj == null) {</span>
<span class="nc" id="L234">                    label = &quot;&quot;;</span>
                } else {
<span class="nc" id="L236">                    label = &quot; (&quot; + Utils.getShortPubkeyName(hashObj.stringValue()) + &quot;)&quot;;</span>
                }
<span class="nc" id="L238">                s = s.replaceFirst(&quot;^([a-zA-Z0-9-]+)_([a-zA-Z0-9-_]+)$&quot;, &quot;$1/$2&quot;);</span>
<span class="nc" id="L239">                repos += &quot;&lt;li&gt;&lt;code&gt;&lt;a href=\&quot;/page/&quot; + s + &quot;\&quot;&gt;&quot; + s + &quot;&lt;/a&gt;&quot; + label + &quot;&lt;/code&gt;&lt;/li&gt;&quot;;</span>
<span class="nc" id="L240">            }</span>
<span class="nc" id="L241">            req.response()</span>
<span class="nc" id="L242">                    .putHeader(&quot;content-type&quot;, &quot;text/html&quot;)</span>
<span class="nc" id="L243">                    .end(&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>
                            + &quot;&lt;html lang='en'&gt;\n&quot;
                            + &quot;&lt;head&gt;\n&quot;
                            + &quot;&lt;title&gt;Nanopub Query: Pubkey Repos&lt;/title&gt;\n&quot;
                            + &quot;&lt;meta charset='utf-8'&gt;\n&quot;
                            + &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/style.css\&quot;&gt;\n&quot;
                            + &quot;&lt;/head&gt;\n&quot;
                            + &quot;&lt;body&gt;\n&quot;
                            + &quot;&lt;h3&gt;Pubkey Repos&lt;/h3&gt;&quot;
                            + &quot;&lt;p&gt;Repos:&lt;/p&gt;&quot;
                            + &quot;&lt;ul&gt;&quot; + repos + &quot;&lt;/ul&gt;&quot;
                            + &quot;&lt;/body&gt;\n&quot;
                            + &quot;&lt;/html&gt;&quot;);
<span class="nc" id="L256">        });</span>
<span class="nc" id="L257">        proxyRouter.route(HttpMethod.GET, &quot;/types&quot;).handler(req -&gt; {</span>
<span class="nc" id="L258">            String repos = &quot;&quot;;</span>
<span class="nc" id="L259">            List&lt;String&gt; repoList = new ArrayList&lt;&gt;(TripleStore.get().getRepositoryNames());</span>
<span class="nc" id="L260">            Collections.sort(repoList);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            for (String s : repoList) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (!s.startsWith(&quot;type_&quot;)) continue;</span>
<span class="nc" id="L263">                String hash = s.replaceFirst(&quot;^([a-zA-Z0-9-]+)_([a-zA-Z0-9-_]+)$&quot;, &quot;$2&quot;);</span>
<span class="nc" id="L264">                Value hashObj = Utils.getObjectForHash(hash);</span>
                String label;
<span class="nc bnc" id="L266" title="All 2 branches missed.">                if (hashObj == null) {</span>
<span class="nc" id="L267">                    label = &quot;&quot;;</span>
                } else {
<span class="nc" id="L269">                    label = &quot; (&quot; + hashObj.stringValue() + &quot;)&quot;;</span>
                }
<span class="nc" id="L271">                s = s.replaceFirst(&quot;^([a-zA-Z0-9-]+)_([a-zA-Z0-9-_]+)$&quot;, &quot;$1/$2&quot;);</span>
<span class="nc" id="L272">                repos += &quot;&lt;li&gt;&lt;code&gt;&lt;a href=\&quot;/page/&quot; + s + &quot;\&quot;&gt;&quot; + s + &quot;&lt;/a&gt;&quot; + label + &quot;&lt;/code&gt;&lt;/li&gt;&quot;;</span>
<span class="nc" id="L273">            }</span>
<span class="nc" id="L274">            req.response()</span>
<span class="nc" id="L275">                    .putHeader(&quot;content-type&quot;, &quot;text/html&quot;)</span>
<span class="nc" id="L276">                    .end(&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>
                            + &quot;&lt;html lang='en'&gt;\n&quot;
                            + &quot;&lt;head&gt;\n&quot;
                            + &quot;&lt;title&gt;Nanopub Query: Type Repos&lt;/title&gt;\n&quot;
                            + &quot;&lt;meta charset='utf-8'&gt;\n&quot;
                            + &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/style.css\&quot;&gt;\n&quot;
                            + &quot;&lt;/head&gt;\n&quot;
                            + &quot;&lt;body&gt;\n&quot;
                            + &quot;&lt;h3&gt;Type Repos&lt;/h3&gt;&quot;
                            + &quot;&lt;p&gt;Repos:&lt;/p&gt;&quot;
                            + &quot;&lt;ul&gt;&quot; + repos + &quot;&lt;/ul&gt;&quot;
                            + &quot;&lt;/body&gt;\n&quot;
                            + &quot;&lt;/html&gt;&quot;);
<span class="nc" id="L289">        });</span>
<span class="nc" id="L290">        proxyRouter.route(HttpMethod.GET, &quot;/style.css&quot;).handler(req -&gt; {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (css == null) {</span>
<span class="nc" id="L292">                css = getResourceAsString(&quot;style.css&quot;);</span>
            }
<span class="nc" id="L294">            req.response().end(css);</span>
<span class="nc" id="L295">        });</span>

<span class="nc" id="L297">        proxyRouter.route(HttpMethod.GET, &quot;/grlc-spec/*&quot;).handler(req -&gt; {</span>
<span class="nc" id="L298">            GrlcSpecPage gsp = new GrlcSpecPage(req.normalizedPath(), req.queryParams());</span>
<span class="nc" id="L299">            String spec = gsp.getSpec();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">            if (spec == null) {</span>
<span class="nc" id="L301">                req.response().setStatusCode(404).end(&quot;query definition not found / not valid&quot;);</span>
            } else {
<span class="nc" id="L303">                req.response().putHeader(&quot;content-type&quot;, &quot;text/yaml&quot;).end(spec);</span>
            }
<span class="nc" id="L305">        });</span>

<span class="nc" id="L307">        proxyRouter.route(HttpMethod.GET, &quot;/openapi/spec/*&quot;).handler(req -&gt; {</span>
<span class="nc" id="L308">            OpenApiSpecPage osp = new OpenApiSpecPage(req.normalizedPath(), req.queryParams());</span>
<span class="nc" id="L309">            String spec = osp.getSpec();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">            if (spec == null) {</span>
<span class="nc" id="L311">                req.response().setStatusCode(404).end(&quot;query definition not found / not valid&quot;);</span>
            } else {
<span class="nc" id="L313">                req.response().putHeader(&quot;content-type&quot;, &quot;text/yaml&quot;).end(spec);</span>
            }
<span class="nc" id="L315">        });</span>

<span class="nc" id="L317">        proxyRouter.route(&quot;/openapi/*&quot;).handler(StaticHandler.create(&quot;com/knowledgepixels/query/swagger&quot;));</span>

<span class="nc" id="L319">        HttpProxy grlcProxy = HttpProxy.reverseProxy(httpClient);</span>
<span class="nc" id="L320">        grlcProxy.origin(80, &quot;grlc&quot;);</span>
<span class="nc" id="L321">        grlcProxy.addInterceptor(new ProxyInterceptor() {</span>

            @Override
            public Future&lt;ProxyResponse&gt; handleProxyRequest(ProxyContext context) {
<span class="nc" id="L325">                final String apiPattern = &quot;^/api/(RA[a-zA-Z0-9-_]{43})/([a-zA-Z0-9-_]+)([?].*)?$&quot;;</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                if (context.request().getURI().matches(apiPattern)) {</span>
<span class="nc" id="L327">                    String artifactCode = context.request().getURI().replaceFirst(apiPattern, &quot;$1&quot;);</span>
<span class="nc" id="L328">                    String queryName = context.request().getURI().replaceFirst(apiPattern, &quot;$2&quot;);</span>
<span class="nc" id="L329">                    String grlcUrlParams = &quot;&quot;;</span>
<span class="nc" id="L330">                    String grlcSpecUrlParams = &quot;&quot;;</span>
<span class="nc" id="L331">                    MultiMap pm = context.request().proxiedRequest().params();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                    for (Entry&lt;String, String&gt; e : pm) {</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                        if (e.getKey().equals(&quot;api-version&quot;)) {</span>
<span class="nc" id="L334">                            grlcSpecUrlParams += &quot;&amp;&quot; + e.getKey() + &quot;=&quot; + URLEncoder.encode(e.getValue(), Charsets.UTF_8);</span>
                        } else {
<span class="nc" id="L336">                            grlcUrlParams += &quot;&amp;&quot; + e.getKey() + &quot;=&quot; + URLEncoder.encode(e.getValue(), Charsets.UTF_8);</span>
                        }
<span class="nc" id="L338">                    }</span>
<span class="nc" id="L339">                    String url = &quot;/api-url/&quot; + queryName +</span>
<span class="nc" id="L340">                            &quot;?specUrl=&quot; + URLEncoder.encode(GrlcSpecPage.nanopubQueryUrl + &quot;grlc-spec/&quot; + artifactCode + &quot;/?&quot; +</span>
                            grlcSpecUrlParams, Charsets.UTF_8) + grlcUrlParams;
<span class="nc" id="L342">                    context.request().setURI(url);</span>
                }
<span class="nc" id="L344">                return context.sendRequest();</span>
            }

            @Override
            public Future&lt;Void&gt; handleProxyResponse(ProxyContext context) {
                // To avoid double entries:
<span class="nc" id="L350">                context.response().headers().remove(&quot;Access-Control-Allow-Origin&quot;);</span>
<span class="nc" id="L351">                return context.sendResponse();</span>
            }

        });

<span class="nc" id="L356">        proxyServer.requestHandler(req -&gt; {</span>
<span class="nc" id="L357">            applyGlobalHeaders(req.response());</span>
<span class="nc" id="L358">            proxyRouter.handle(req);</span>
<span class="nc" id="L359">        });</span>
<span class="nc" id="L360">        proxyServer.listen(9393);</span>

<span class="nc" id="L362">        proxyRouter.route(&quot;/api/*&quot;).handler(ProxyHandler.create(grlcProxy));</span>
<span class="nc" id="L363">        proxyRouter.route(&quot;/static/*&quot;).handler(ProxyHandler.create(grlcProxy));</span>

<span class="nc" id="L365">        vertx.createHttpServer().requestHandler(req -&gt; {</span>
            try {
<span class="nc" id="L367">                final StringBuilder payload = new StringBuilder();</span>
<span class="nc" id="L368">                req.handler(data -&gt; payload.append(data.toString(&quot;UTF-8&quot;)));</span>
<span class="nc" id="L369">                req.endHandler(handler -&gt; {</span>
<span class="nc" id="L370">                    final String dataString = payload.toString();</span>
                    try {
<span class="nc" id="L372">                        Nanopub np = new NanopubImpl(dataString, RDFFormat.TRIG);</span>
<span class="nc" id="L373">                        NanopubLoader.load(np, -1);</span>
<span class="nc" id="L374">                    } catch (MalformedNanopubException ex) {</span>
<span class="nc" id="L375">                        req.response().setStatusCode(HttpStatus.SC_BAD_REQUEST)</span>
<span class="nc" id="L376">                                .setStatusMessage(Arrays.toString(ex.getStackTrace()))</span>
<span class="nc" id="L377">                                .end();</span>
<span class="nc" id="L378">                        ex.printStackTrace();</span>
<span class="nc" id="L379">                        return;</span>
<span class="nc" id="L380">                    }</span>
<span class="nc" id="L381">                    req.response()</span>
<span class="nc" id="L382">                            .setStatusCode(HttpStatus.SC_OK)</span>
<span class="nc" id="L383">                            .end();</span>
<span class="nc" id="L384">                });</span>
<span class="nc" id="L385">            } catch (Exception ex) {</span>
<span class="nc" id="L386">                req.response().setStatusCode(HttpStatus.SC_BAD_REQUEST)</span>
<span class="nc" id="L387">                        .setStatusMessage(Arrays.toString(ex.getStackTrace()))</span>
<span class="nc" id="L388">                        .end();</span>
<span class="nc" id="L389">            }</span>
<span class="nc" id="L390">        }).listen(9300).onComplete(http -&gt; {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">            if (http.succeeded()) {</span>
<span class="nc" id="L392">                server2Started = true;</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                if (allServersStarted()) startPromise.complete();</span>
<span class="nc" id="L394">                System.out.println(&quot;HTTP server started on port 9300&quot;);</span>
            } else {
<span class="nc" id="L396">                startPromise.fail(http.cause());</span>
            }
<span class="nc" id="L398">        });</span>

        // Periodic metrics update
<span class="nc" id="L401">        vertx.setPeriodic(1000, id -&gt; collector.updateMetrics());</span>


<span class="nc" id="L404">        new Thread(() -&gt; {</span>
            try {
<span class="nc" id="L406">                var status = StatusController.get().initialize();</span>
<span class="nc" id="L407">                System.err.println(&quot;Current state: &quot; + status.state + &quot;, last committed counter: &quot; + status.loadCounter);</span>
<span class="nc bnc" id="L408" title="All 4 branches missed.">                if (status.state == StatusController.State.LAUNCHING || status.state == StatusController.State.LOADING_INITIAL) {</span>
                    // Do the initial nanopublication loading
<span class="nc" id="L410">                    StatusController.get().setLoadingInitial(status.loadCounter);</span>
                    // Fall back to local nanopub loading if the local files are present
<span class="nc bnc" id="L412" title="All 2 branches missed.">                    if (!LocalNanopubLoader.init()) {</span>
<span class="nc" id="L413">                        JellyNanopubLoader.loadInitial(status.loadCounter);</span>
                    } else {
<span class="nc" id="L415">                        System.err.println(&quot;Local nanopublication loading finished&quot;);</span>
                    }
<span class="nc" id="L417">                    StatusController.get().setReady();</span>
                } else {
<span class="nc" id="L419">                    System.err.println(&quot;Initial load is already done&quot;);</span>
<span class="nc" id="L420">                    StatusController.get().setReady();</span>
                }
<span class="nc" id="L422">            } catch (Exception ex) {</span>
<span class="nc" id="L423">                ex.printStackTrace();</span>
<span class="nc" id="L424">                System.err.println(&quot;Initial load failed, terminating...&quot;);</span>
<span class="nc" id="L425">                Runtime.getRuntime().exit(1);</span>
<span class="nc" id="L426">            }</span>

            // Start periodic nanopub loading
<span class="nc" id="L429">            System.err.println(&quot;Starting periodic nanopub loading...&quot;);</span>
<span class="nc" id="L430">            var executor = Executors.newSingleThreadScheduledExecutor();</span>
<span class="nc" id="L431">            executor.scheduleWithFixedDelay(</span>
                    JellyNanopubLoader::loadUpdates,
                    JellyNanopubLoader.UPDATES_POLL_INTERVAL,
                    JellyNanopubLoader.UPDATES_POLL_INTERVAL,
                    TimeUnit.MILLISECONDS
            );
<span class="nc" id="L437">        }).start();</span>

<span class="nc" id="L439">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {</span>
            try {
<span class="nc" id="L441">                System.err.println(&quot;Gracefully shutting down...&quot;);</span>
<span class="nc" id="L442">                TripleStore.get().shutdownRepositories();</span>
<span class="nc" id="L443">                vertx.close().toCompletionStage().toCompletableFuture().get(5, TimeUnit.SECONDS);</span>
<span class="nc" id="L444">                System.err.println(&quot;Graceful shutdown completed&quot;);</span>
<span class="nc" id="L445">            } catch (Exception ex) {</span>
<span class="nc" id="L446">                System.err.println(&quot;Graceful shutdown failed&quot;);</span>
<span class="nc" id="L447">                ex.printStackTrace();</span>
<span class="nc" id="L448">            }</span>
<span class="nc" id="L449">        }));</span>
<span class="nc" id="L450">    }</span>

    private String getResourceAsString(String file) {
<span class="nc" id="L453">        InputStream is = getClass().getClassLoader().getResourceAsStream(&quot;com/knowledgepixels/query/&quot; + file);</span>
<span class="nc" id="L454">        try (Scanner s = new Scanner(is).useDelimiter(&quot;\\A&quot;)) {</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">            String fileContent = s.hasNext() ? s.next() : &quot;&quot;;</span>
<span class="nc" id="L456">            return fileContent;</span>
        }
    }

    private static void handleRedirect(RoutingContext req, String path) {
<span class="nc" id="L461">        String queryString = &quot;&quot;;</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (!req.queryParam(&quot;query&quot;).isEmpty())</span>
<span class="nc" id="L463">            queryString = &quot;?query=&quot; + URLEncoder.encode(req.queryParam(&quot;query&quot;).get(0), Charsets.UTF_8);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (req.queryParam(&quot;for-type&quot;).size() == 1) {</span>
<span class="nc" id="L465">            String type = req.queryParam(&quot;for-type&quot;).get(0);</span>
<span class="nc" id="L466">            req.response().putHeader(&quot;location&quot;, path + &quot;/type/&quot; + Utils.createHash(type) + queryString);</span>
<span class="nc" id="L467">            req.response().setStatusCode(301).end();</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">        } else if (req.queryParam(&quot;for-pubkey&quot;).size() == 1) {</span>
<span class="nc" id="L469">            String type = req.queryParam(&quot;for-pubkey&quot;).get(0);</span>
<span class="nc" id="L470">            req.response().putHeader(&quot;location&quot;, path + &quot;/pubkey/&quot; + Utils.createHash(type) + queryString);</span>
<span class="nc" id="L471">            req.response().setStatusCode(301).end();</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">        } else if (req.queryParam(&quot;for-user&quot;).size() == 1) {</span>
<span class="nc" id="L473">            String type = req.queryParam(&quot;for-user&quot;).get(0);</span>
<span class="nc" id="L474">            req.response().putHeader(&quot;location&quot;, path + &quot;/user/&quot; + Utils.createHash(type) + queryString);</span>
<span class="nc" id="L475">            req.response().setStatusCode(301).end();</span>
        }
<span class="nc" id="L477">    }</span>

    /**
     * Apply headers to the response that should be present for all requests.
     *
     * @param response The response to which the headers should be applied.
     */
    private static void applyGlobalHeaders(HttpServerResponse response) {
<span class="nc" id="L485">        response.putHeader(&quot;Nanopub-Query-Status&quot;, StatusController.get().getState().state.toString());</span>
<span class="nc" id="L486">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>